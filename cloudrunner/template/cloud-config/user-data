#cloud-config
hostname: {{node.name}}
users:
 - default
 - name: stack
   lock-passwd: false
   passwd: $6$rounds=4096$iX2Wgme5F1tgJk$duqxV0FKu7A6zLgcxfVF6s5ipzIVh4q.1yPjOwpFwOS3QcL68rVYXR0ao.3XJFCtd700SaNkDV4KmWvy3LkTb.
   sudo: "ALL=(ALL) NOPASSWD:ALL"
   groups: sudo
   shell: /bin/bash
   ssh-authorized-keys:
   {% if app.server_key %}
    - {{app.server_key}}
   {% endif %}
    - {{app.key_pair.public}}

write_files:
  - path: /home/stack/.ssh/id_rsa
    permissions: '0600'
    owner: stack:stack
    content: |
      {{app.key_pair.private}}

  - path: /home/stack/.ssh/id_rsa.pub
    permissions: '0600'
    owner: stack:stack
    content: |
      {{app.key_pair.public}}

bootcmd:
 - echo nameserver {{app.network.gateway}} > /etc/resolv.conf
{% for node in app.nodes %}
 - echo {{node.address}} {{node.name}} >> /etc/hosts
{% endfor %}


packages:
 - git
 - traceroute
 - python
 - python-simplejson

phone_home:
  url: http://{{app.network.gateway}}:{{app.callback_port}}
  post: all
